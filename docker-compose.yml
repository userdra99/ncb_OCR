

services:
  # =============================================================================
  # Redis - Using local Redis on host (port 6379)
  # =============================================================================
  # redis service commented out - using host Redis instead

  # =============================================================================
  # Claims Data Entry Agent - Main Application (GPU-enabled)
  # =============================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: claims-app
    restart: unless-stopped
    network_mode: "host"
    environment:
      # Application
      - APP_ENV=development
      - APP_DEBUG=true
      - LOG_LEVEL=INFO
      - LOG_FORMAT=console

      # Redis (using host's local Redis via host network)
      - REDIS_URL=redis://localhost:6379/0

      # OCR (temporarily using CPU until cuDNN issue resolved)
      - OCR_USE_GPU=false
      - OCR_DEFAULT_LANGUAGE=en
      - OCR_DETECTION_THRESHOLD=0.5
      - OCR_RECOGNITION_THRESHOLD=0.5
      - OCR_HIGH_CONFIDENCE_THRESHOLD=0.90
      - OCR_MEDIUM_CONFIDENCE_THRESHOLD=0.75
      - OCR_BATCH_SIZE=6
      - OCR_MAX_IMAGE_SIZE=4096

      # GPU Configuration (CUDA 12.9 with native Blackwell support for RTX 5090)
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
      - GPU_TYPE=${GPU_TYPE:-RTX5090}
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
      - LD_LIBRARY_PATH=/usr/local/cuda-12.9/lib64:/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH:-}

      # Storage
      - TEMP_STORAGE_PATH=/app/data/temp
      - TEMP_FILE_MAX_AGE_HOURS=24

      # Admin
      - ADMIN_PORT=8080
    env_file:
      - .env
    volumes:
      # Source code (for development hot reload)
      - ./src:/app/src:ro

      # Tests directory (for running tests in container)
      - ./tests:/app/tests:ro

      # Secrets (writable for OAuth token refresh)
      - ./secrets:/app/secrets

      # Data persistence
      - app-data:/app/data
      - app-logs:/app/logs

      # Development: Install pre-commit hooks
      - ./.git:/app/.git:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: ${GPU_COUNT:-1}
              capabilities: [gpu]
    shm_size: ${SHM_SIZE:-8gb}
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8080/health', timeout=5.0)"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

  # =============================================================================
  # CPU-only variant (uncomment to use instead of GPU version)
  # =============================================================================
  # app-cpu:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #     target: cpu-only
  #   container_name: claims-app-cpu
  #   restart: unless-stopped
  #   depends_on:
  #     redis:
  #       condition: service_healthy
  #   ports:
  #     - "8080:8080"
  #     - "9090:9090"
  #   environment:
  #     - APP_ENV=development
  #     - APP_DEBUG=true
  #     - LOG_LEVEL=INFO
  #     - LOG_FORMAT=console
  #     - REDIS_URL=redis://redis:6379/0
  #     - OCR_USE_GPU=false
  #   env_file:
  #     - .env
  #   volumes:
  #     - ./src:/app/src:ro
  #     - ./secrets:/app/secrets:ro
  #     - app-data:/app/data
  #     - app-logs:/app/logs
  #   networks:
  #     - claims-network

networks:
  claims-network:
    driver: bridge

volumes:
  app-data:
    driver: local
  app-logs:
    driver: local
